<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°å­¦ç»ƒä¹ é¢˜</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 15px;
            background-color: #f5f5f5;
        }
        
        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
        }
        
        .container {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        #problems {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 600px) {
            #problems {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
        }
        
        .header-info {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-bottom: 30px;
        }
        
        .header-info span {
            margin: 0 15px;
        }
        
        .problem {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fafafa;
            min-height: 120px;
        }
        
        .problem-content {
            margin-bottom: 15px;
        }
        
        .verification-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #ccc;
        }
        
        .verification-title {
            font-size: 16px;
            color: #666;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .verification-form {
            display: inline-block;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
        }
        
        .problem-number {
            font-weight: bold;
            color: #666;
            margin-bottom: 6px;
            font-size: 13px;
        }
        
        .problem-text {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
            color: #333;
        }
        
        .vertical-form {
            display: inline-block;
            font-family: 'Courier New', monospace;
            margin: 15px 0 10px 0;
            min-width: 160px;
        }
        
        @media (max-width: 600px) {
            .vertical-form {
                margin: 10px 0 5px 0;
                min-width: 120px;
            }
        }
        
        /* 5X3éšå½¢è¡¨æ ¼ç³»ç»Ÿï¼ˆæ”¯æŒåƒä½ï¼‰ */
        .vertical-table {
            display: grid;
            grid-template-columns: repeat(5, 40px);
            grid-template-rows: repeat(5, 30px);
            gap: 2px;
            align-items: center;
            justify-items: end;
        }
        
        @media (max-width: 600px) {
            .vertical-table {
                grid-template-columns: repeat(5, 35px);
                grid-template-rows: repeat(5, 28px);
                gap: 1px;
            }
        }
        
        .cell {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            width: 100%;
            height: 100%;
            font-family: 'Courier New', monospace;
            overflow: hidden;
        }
        
        .cell input {
            width: 100%;
            height: 100%;
        }
        
        .digit-cell {
            font-size: 24px;
            font-weight: bold;
        }
        
        @media (max-width: 600px) {
            .digit-cell {
                font-size: 22px;
            }
        }
        
        .operator-cell {
            font-size: 20px;
            font-weight: bold;
            margin-left: 5px;
        }
        
        @media (max-width: 600px) {
            .operator-cell {
                font-size: 18px;
                margin-left: 3px;
            }
        }
        
        .line-cell {
            border-bottom: 3px solid #333;
            height: 20px;
            margin-top: 5px;
            margin-bottom: 15px;
        }
        
        .equals-cell {
            font-size: 20px;
            font-weight: bold;
        }
        
        @media (max-width: 600px) {
            .equals-cell {
                font-size: 18px;
            }
        }
        
        .vertical-answer-input {
            font-size: 24px;
            font-weight: bold;
            width: 100%;
            height: 100%;
            padding: 2px;
            border: 2px solid #4CAF50;
            border-radius: 3px;
            text-align: center;
            font-family: 'Courier New', monospace;
            box-sizing: border-box;
        }
        
        @media (max-width: 600px) {
            .vertical-answer-input {
                font-size: 22px;
            }
        }
        
        .answer-cell {
            grid-column: span 3;
        }
        
        .vertical-answer-input:focus {
            border-color: #2E7D32;
            outline: none;
        }
        

        
        .carry-input::-webkit-outer-spin-button,
        .carry-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .carry-input:focus {
            border-color: #F57C00;
            outline: none;
            background-color: #FFF3E0;
        }
        
        .carry-row {
            font-size: 16px;
            margin: 1px 0;
            padding-left: 15px;
            display: flex;
            justify-content: flex-end;
            align-items: flex-start;
        }
        
        .carry-input {
            font-size: 14px;
            font-weight: bold;
            width: 20px;
            height: 20px;
            padding: 1px 2px;
            border: 1px solid #FF9800;
            border-radius: 2px;
            text-align: center;
            font-family: 'Courier New', monospace;
            background-color: #FFF8E1;
            margin: 0 1px;
            -moz-appearance: textfield;
            appearance: none;
            line-height: 18px;
            box-sizing: border-box;
        }
        
        .carry-input::-webkit-outer-spin-button,
        .carry-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .carry-input:focus {
            border-color: #F57C00;
            outline: none;
            background-color: #FFF3E0;
        }
        
        @media (max-width: 600px) {
            .carry-input {
                width: 18px;
                height: 18px;
                font-size: 12px;
                padding: 1px;
                line-height: 16px;
            }
            
            .carry-row {
                font-size: 14px;
                padding-left: 8px;
                margin: 1px 0;
            }
        }
        
        .problem-type {
            color: #888;
            font-size: 14px;
            text-align: center;
            margin-bottom: 15px;
        }
        

        
        .submit-section {
            text-align: center;
            margin-top: 30px;
        }
        
        .submit-btn {
            background-color: #4CAF50;
            color: white;
            padding: 12px 30px;
            font-size: 18px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .submit-btn:hover {
            background-color: #45a049;
        }
        
        .refresh-btn {
            background-color: #2196F3;
            color: white;
            padding: 12px 30px;
            font-size: 18px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-left: 15px;
        }
        
        .refresh-btn:hover {
            background-color: #1976D2;
        }
        
        .button-group {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }
        
        .results {
            margin-top: 30px;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .correct {
            background-color: #d4edda;
            border: 2px solid #c3e6cb;
            color: #155724;
        }
        
        .incorrect {
            background-color: #f8d7da;
            border: 2px solid #f5c6cb;
            color: #721c24;
        }
        
        .partial {
            background-color: #fff3cd;
            border: 2px solid #ffeaa7;
            color: #856404;
        }
        
        .score {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .feedback {
            margin-top: 20px;
        }
        
        .feedback-item {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
        }
        
        .feedback-correct {
            background-color: #d4edda;
            color: #155724;
        }
        
        .feedback-incorrect {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .feedback-partial-correct {
            background-color: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>æå’ŒåŒå­¦çš„æ•°å­¦ç«–å¼ç»ƒä¹ é¢˜</h1>
        <div class="header-info">
            <span>æ—¥æœŸï¼š2025å¹´12æœˆ21æ—¥</span>
            <span>è¯•å·ç¼–å·ï¼š<span id="paperCode"></span></span>
        </div>
        <div id="problems"></div>
        
        <div class="submit-section">
            <div class="button-group">
                <button class="refresh-btn" onclick="refreshProblems()">ğŸ”„ åˆ·æ–°é¢˜ç›®</button>
                <button class="submit-btn" onclick="checkAnswers()">æäº¤ç­”æ¡ˆ</button>
            </div>
        </div>
        
        <div id="results" style="display: none;"></div>
    </div>

    <script>
        // é¢˜ç›®æ•°æ®å’Œæ­£ç¡®ç­”æ¡ˆ
        let problems = [];
        let answers = [];

        // ç”Ÿæˆéšæœºæ•°
        function randomNumber(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // ç”Ÿæˆè¯•å·ç¼–å·
        function generatePaperCode() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const random = Math.floor(Math.random() * 9000) + 1000;
            return `${year}${month}${day}-${random}`;
        }

        // ç”Ÿæˆé¢˜ç›®
        function generateProblems() {
            problems = [];
            answers = [];
            
            // ç”Ÿæˆ2é“ä¸‰ä½æ•°åŠ æ³•é¢˜
            for (let i = 0; i < 2; i++) {
                let num1 = randomNumber(100, 999);
                let num2 = randomNumber(100, 999);
                const answer = num1 + num2;
                console.log(`Generated problem ${i+1}: ${num1} + ${num2} = ${answer}`);
                problems.push({
                    type: 'åŠ æ³•',
                    text: `${num1} + ${num2} = ?`,
                    num1: num1,
                    num2: num2,
                    operator: '+',
                    correctAnswer: answer
                });
            }
            
            // ç”Ÿæˆ2é“ä¸‰ä½æ•°å‡æ³•é¢˜ï¼ˆç¡®ä¿ç»“æœä¸ºæ­£æ•°ï¼‰
            for (let i = 0; i < 2; i++) {
                let num1 = randomNumber(500, 999);
                let num2 = randomNumber(100, Math.min(499, num1 - 1)); // ç¡®ä¿ç»“æœä¸ºæ­£æ•°
                const answer = num1 - num2;
                console.log(`Generated subtraction problem ${i+1}: ${num1} - ${num2} = ${answer}`);
                problems.push({
                    type: 'å‡æ³•',
                    text: `${num1} - ${num2} = ?`,
                    num1: num1,
                    num2: num2,
                    operator: '-',
                    correctAnswer: answer
                });
            }
            
            // ç”Ÿæˆ2é“ä¸€ä½æ•°ä¹˜ä¸‰ä½æ•°é¢˜
            for (let i = 0; i < 2; i++) {
                let digit = randomNumber(2, 9);
                let num = randomNumber(100, 999);
                problems.push({
                    type: 'ä¹˜æ³•',
                    text: `${digit} Ã— ${num} = ?`,
                    num1: digit,
                    num2: num,
                    operator: 'Ã—',
                    correctAnswer: digit * num
                });
            }
            
            displayProblems();
        }

        // æ˜¾ç¤ºé¢˜ç›®
        function displayProblems() {
            const problemsContainer = document.getElementById('problems');
            problemsContainer.innerHTML = '';
            
            problems.forEach((problem, index) => {
                const problemDiv = document.createElement('div');
                problemDiv.className = 'problem';
                problemDiv.innerHTML = `
                    <div class="problem-number">ç¬¬ ${index + 1} é¢˜</div>
                    <div class="problem-content">
                        ${createVerticalForm(problem, index)}
                    </div>
                    <div class="verification-section">
                        <div class="verification-title">éªŒç®—ï¼ˆå¯é€‰ï¼‰ï¼š</div>
                        <div class="verification-form" id="verification${index}">
                            ${createVerificationForm(problem, index)}
                        </div>
                    </div>
                `;
                problemsContainer.appendChild(problemDiv);
            });
        }
        


        // åˆ›å»ºç®€å•çš„ç«–å¼è¡¨æ ¼ - åªæ˜¾ç¤ºï¼Œä¸å¤„ç†é€»è¾‘
        function createVerticalForm(problem, index = null, showAnswer = false) {
            let tableHTML = '<div class="vertical-table">';
            
            // ä¹˜æ³•è¿ç®—æ—¶ï¼Œä¸‰ä½æ•°åœ¨ä¸Šé¢ï¼Œä¸€ä½æ•°åœ¨ä¸‹é¢
            let upperNum, lowerNum, operator;
            if (problem.type === 'ä¹˜æ³•') {
                // ç¡®ä¿ä¸‰ä½æ•°åœ¨ä¸Šé¢
                if (problem.num1 >= 100) {
                    upperNum = problem.num1;
                    lowerNum = problem.num2;
                } else {
                    upperNum = problem.num2;
                    lowerNum = problem.num1;
                }
                operator = 'Ã—';
            } else {
                upperNum = problem.num1;
                lowerNum = problem.num2;
                operator = problem.operator;
            }
            
            const upperStr = upperNum.toString();
            const lowerStr = lowerNum.toString();
            
            // ç¬¬ä¸€è¡Œï¼šç©ºç™½ + ä¸Šé¢çš„æ•°å­—ï¼ˆå³å¯¹é½æ˜¾ç¤ºï¼Œæ”¯æŒåƒä½ï¼‰
            tableHTML += '<div class="cell"></div>'; // ç¬¬ä¸€åˆ—ç©ºç™½
            const upperPadded = upperStr.padStart(4, ' '); // æœ€å¤š4ä½ï¼ˆåƒä½ï¼‰
            for (let i = 0; i < 4; i++) {
                tableHTML += '<div class="cell digit-cell">' + upperPadded.charAt(i) + '</div>';
            }
            
            // ç¬¬äºŒè¡Œï¼šæ“ä½œç¬¦ + ä¸‹é¢çš„æ•°å­—ï¼ˆå³å¯¹é½æ˜¾ç¤ºï¼Œæ”¯æŒåƒä½ï¼‰
            tableHTML += '<div class="cell operator-cell">' + operator + '</div>';
            const lowerPadded = lowerStr.padStart(4, ' '); // æœ€å¤š4ä½ï¼ˆåƒä½ï¼‰
            for (let i = 0; i < 4; i++) {
                tableHTML += '<div class="cell digit-cell">' + lowerPadded.charAt(i) + '</div>';
            }
            
            // ç¬¬ä¸‰è¡Œï¼šè¿›ä½æ¡†ï¼ˆæ”¯æŒåƒä½ï¼‰
            for (let i = 0; i < 5; i++) {
                if (i === 0) {
                    tableHTML += '<div class="cell"></div>';
                } else if (i < 4) { // æ˜¾ç¤ºåä½ã€ç™¾ä½ã€åƒä½çš„è¿›ä½æ¡†
                    if (problem.type === 'å‡æ³•') {
                        tableHTML += `<div class="cell"><input type="number" class="carry-input" id="borrow${index}_${i}" placeholder="å€Ÿä½" min="0" max="9" style="border-color: #9C27B0; background-color: #F3E5F5;" /></div>`;
                    } else {
                        tableHTML += `<div class="cell"><input type="number" class="carry-input" id="carry${index}_${i}" placeholder="è¿›ä½" min="0" max="9" /></div>`;
                    }
                } else {
                    tableHTML += '<div class="cell"></div>';
                }
            }
            
            // ç¬¬å››è¡Œï¼šåˆ†éš”çº¿ï¼ˆè¦†ç›–5åˆ—ï¼‰
            tableHTML += '<div class="cell line-cell" style="grid-column: 1 / 6;"></div>';
            
            // ç¬¬äº”è¡Œï¼šç­”æ¡ˆï¼ˆæ”¯æŒåƒä½ï¼‰
            if (showAnswer) {
                // æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
                const answerStr = problem.correctAnswer.toString();
                tableHTML += '<div class="cell equals-cell">=</div>';
                const answerPadded = answerStr.padStart(4, ' '); // æœ€å¤š4ä½ï¼ˆåƒä½ï¼‰
                for (let i = 0; i < 4; i++) {
                    tableHTML += '<div class="cell digit-cell">' + answerPadded.charAt(i) + '</div>';
                }
                tableHTML += '<div class="cell"></div>';
            } else {
                // ç­”æ¡ˆè¾“å…¥æ¨¡å¼
                tableHTML += '<div class="cell equals-cell">=</div>';
                tableHTML += '<div class="cell answer-cell" style="grid-column: span 4;"><input type="number" class="vertical-answer-input" id="answer' + index + '" placeholder="ç­”æ¡ˆ" /></div>';
            }
            
            tableHTML += '</div>';
            return tableHTML;
        }

        // åˆ›å»ºéªŒç®—ç«–å¼
        function createVerificationForm(problem, index) {
            // è·å–ç›¸åè¿ç®—ç¬¦
            const getOppositeOperator = (operator) => {
                switch (operator) {
                    case '+': return '-';
                    case '-': return '+';
                    case 'Ã—': return 'Ã·';
                    default: return operator;
                }
            };
            
            // ä¹˜æ³•æ—¶ï¼ŒéªŒç®—ä½¿ç”¨é™¤æ³•
            let verificationOperator;
            let secondNum; // ç¬¬äºŒè¡Œæ•°å­—
            if (problem.type === 'ä¹˜æ³•') {
                // éªŒç®—ï¼šç­”æ¡ˆ Ã· ä¸€ä½æ•° = ä¸‰ä½æ•°
                if (problem.num1 >= 100) {
                    secondNum = problem.num2; // ä¸€ä½æ•°åœ¨ä¸‹é¢
                } else {
                    secondNum = problem.num1; // ä¸€ä½æ•°åœ¨ä¸‹é¢
                }
                verificationOperator = 'Ã·';
            } else {
                secondNum = problem.num1; // é¢˜ç›®ç¬¬ä¸€è¡Œæ•°å­—
                verificationOperator = getOppositeOperator(problem.operator);
            }
            
            let tableHTML = '<div class="vertical-table">';
            
            const secondNumStr = secondNum.toString();
            
            // ç¬¬ä¸€è¡Œï¼šç©ºç™½ + ç”¨æˆ·è¾“å…¥çš„éªŒç®—ç¬¬ä¸€è¡Œæ•°å­—
            tableHTML += '<div class="cell"></div>'; // ç¬¬ä¸€åˆ—ç©ºç™½
            tableHTML += '<div class="cell answer-cell" style="grid-column: span 4;"><input type="number" class="vertical-answer-input" id="verify-first' + index + '" placeholder="ä½ å¡«å†™çš„ç­”æ¡ˆ" style="border-color: #4CAF50; background-color: #E8F5E8;" /></div>';
            
            // ç¬¬äºŒè¡Œï¼šéªŒç®—è¿ç®—ç¬¦ + éªŒç®—ç¬¬äºŒè¡Œæ•°å­—
            tableHTML += '<div class="cell operator-cell">' + verificationOperator + '</div>';
            const secondNumPadded = secondNumStr.padStart(4, ' ');
            for (let i = 0; i < 4; i++) {
                tableHTML += '<div class="cell digit-cell">' + secondNumPadded.charAt(i) + '</div>';
            }
            
            // ç¬¬ä¸‰è¡Œï¼šéªŒç®—è¿›ä½/å€Ÿä½æ¡†ï¼ˆå¦‚æœéœ€è¦ï¼‰
            for (let i = 0; i < 5; i++) {
                if (i === 0) {
                    tableHTML += '<div class="cell"></div>';
                } else if (i < 4) {
                    if (verificationOperator === 'Ã·') {
                        tableHTML += '<div class="cell"></div>'; // é™¤æ³•ä¸éœ€è¦è¿›ä½æ¡†
                    } else {
                        // éªŒç®—ä¸­ç»Ÿä¸€ä½¿ç”¨"å€Ÿä½"æ ‡ç­¾ï¼ˆå› ä¸ºéªŒç®—æ—¶éƒ½æ˜¯å‡æ³•è¿ç®—ï¼‰
                        tableHTML += '<div class="cell"><input type="number" class="carry-input" id="verify-carry' + index + '_' + i + '" placeholder="å€Ÿä½" min="0" max="9" style="border-color: #4CAF50; background-color: #E8F5E8;" /></div>';
                    }
                } else {
                    tableHTML += '<div class="cell"></div>';
                }
            }
            
            // ç¬¬å››è¡Œï¼šåˆ†éš”çº¿
            tableHTML += '<div class="cell line-cell" style="grid-column: 1 / 6;"></div>';
            
            // ç¬¬äº”è¡Œï¼šéªŒç®—ç»“æœï¼ˆåº”è¯¥ç­‰äºé¢˜ç›®ç¬¬äºŒè¡Œæ•°å­—ï¼‰
            tableHTML += '<div class="cell equals-cell">=</div>';
            tableHTML += '<div class="cell answer-cell" style="grid-column: span 4;"><input type="number" class="vertical-answer-input" id="verify-answer' + index + '" placeholder="éªŒç®—ç»“æœ" /></div>';
            
            tableHTML += '</div>';
            
            return tableHTML;
        }

        // è®¡ç®—è¿›ä½/å€Ÿä½
        function calculateCarryBorrow(problem) {
            const num1 = problem.num1;
            const num2 = problem.num2;
            
            // æå–å„ä½æ•°å­—ï¼ˆä¸ªä½ã€åä½ã€ç™¾ä½ï¼‰
            const num1Digits = {
                ones: num1 % 10,
                tens: Math.floor(num1 / 10) % 10,
                hundreds: Math.floor(num1 / 100)
            };
            
            const num2Digits = {
                ones: num2 % 10,
                tens: Math.floor(num2 / 10) % 10,
                hundreds: Math.floor(num2 / 100)
            };
            
            if (problem.type === 'åŠ æ³•' || problem.type === 'ä¹˜æ³•') {
                // è®¡ç®—è¿›ä½ï¼ˆä»ä½ä½åˆ°é«˜ä½ï¼Œæ”¯æŒåƒä½ï¼‰
                const carries = {
                    tens: 0,      // åä½è¿›ä½åˆ°ç™¾ä½
                    hundreds: 0,  // ç™¾ä½è¿›ä½åˆ°åƒä½
                    thousands: 0  // åƒä½è¿›ä½åˆ°ä¸‡ä½
                };
                
                if (problem.type === 'åŠ æ³•') {
                    // ä¸ªä½è¿›ä½
                    const onesSum = num1Digits.ones + num2Digits.ones;
                    if (onesSum >= 10) {
                        carries.tens = Math.floor(onesSum / 10);
                    }
                    
                    // åä½è¿›ä½
                    const tensSum = num1Digits.tens + num2Digits.tens + carries.tens;
                    if (tensSum >= 10) {
                        carries.hundreds = Math.floor(tensSum / 10);
                    }
                    
                    // ç™¾ä½è¿›ä½
                    const hundredsSum = num1Digits.hundreds + num2Digits.hundreds + carries.hundreds;
                    if (hundredsSum >= 10) {
                        carries.thousands = Math.floor(hundredsSum / 10);
                    }
                } else if (problem.type === 'ä¹˜æ³•') {
                    // ä¹˜æ³•è¿›ä½è®¡ç®—ï¼šå•ä¸€ä½æ•° Ã— ä¸‰ä½æ•°
                    // ä¸ªä½éƒ¨åˆ†ç§¯
                    const onesProduct = num1Digits.ones * num2Digits.ones;
                    if (onesProduct >= 10) {
                        carries.tens = Math.floor(onesProduct / 10);
                    }
                    
                    // åä½éƒ¨åˆ†ç§¯ + ä¸ªä½è¿›ä½
                    const tensProduct = num1Digits.ones * num2Digits.tens + carries.tens;
                    if (tensProduct >= 10) {
                        carries.hundreds = Math.floor(tensProduct / 10);
                    }
                    
                    // ç™¾ä½éƒ¨åˆ†ç§¯ + åä½è¿›ä½
                    const hundredsProduct = num1Digits.ones * num2Digits.hundreds + carries.hundreds;
                    if (hundredsProduct >= 10) {
                        // è¿™é‡Œå¯èƒ½éœ€è¦åƒä½è¿›ä½ï¼Œä½†æˆ‘ä»¬çš„é¢˜ç›®ä¸»è¦æ˜¯ä¸‰ä½æ•°ç»“æœ
                        carries.thousands = Math.floor(hundredsProduct / 10);
                    }
                }
                
                return carries;
            } else if (problem.type === 'å‡æ³•') {
                // è®¡ç®—å€Ÿä½ï¼ˆæ”¯æŒåƒä½ï¼‰
                const borrows = {
                    tens: 0,      // åä½å‘ç™¾ä½å€Ÿä½
                    hundreds: 0,  // ç™¾ä½å‘åƒä½å€Ÿä½
                    thousands: 0  // åƒä½å‘ä¸‡ä½å€Ÿä½
                };
                
                // ä¸ªä½å€Ÿä½
                if (num1Digits.ones < num2Digits.ones) {
                    borrows.tens = 1;
                }
                
                // åä½å€Ÿä½
                const tensResult = num1Digits.tens - num2Digits.tens - borrows.tens;
                if (tensResult < 0) {
                    borrows.hundreds = 1;
                }
                
                // ç™¾ä½å€Ÿä½
                const hundredsResult = num1Digits.hundreds - num2Digits.hundreds - borrows.hundreds;
                if (hundredsResult < 0) {
                    borrows.thousands = 1;
                }
                
                return borrows;
            }
            
            return {};
        }

        // æ£€æŸ¥ç­”æ¡ˆ
        function checkAnswers() {
            let correctCount = 0;
            let feedback = [];
            
            problems.forEach((problem, index) => {
                const userAnswer = document.getElementById(`answer${index}`).value;
                
                // éªŒè¯æœ€ç»ˆç­”æ¡ˆ
                const isAnswerCorrect = parseInt(userAnswer) === problem.correctAnswer;
                
                // éªŒè¯è¿›ä½/å€Ÿä½
                const correctCarryBorrow = calculateCarryBorrow(problem);
                const userCarryBorrow = {
                    tens: parseInt(document.getElementById(`carry${index}_3`)?.value || document.getElementById(`borrow${index}_3`)?.value || 0),
                    hundreds: parseInt(document.getElementById(`carry${index}_2`)?.value || document.getElementById(`borrow${index}_2`)?.value || 0),
                    thousands: parseInt(document.getElementById(`carry${index}_1`)?.value || document.getElementById(`borrow${index}_1`)?.value || 0)
                };
                
                const isCarryCorrect = (correctCarryBorrow.tens === userCarryBorrow.tens) && 
                                      (correctCarryBorrow.hundreds === userCarryBorrow.hundreds) &&
                                      (correctCarryBorrow.thousands === userCarryBorrow.thousands);
                
                // éªŒè¯éªŒç®—ç»“æœï¼ˆå¦‚æœç”¨æˆ·å¡«å†™äº†ï¼‰
                const userVerificationFirst = document.getElementById(`verify-first${index}`)?.value;
                const userVerificationAnswer = document.getElementById(`verify-answer${index}`)?.value;
                let isVerificationCorrect = false;
                let verificationCorrectAnswer = null;
                let verificationExplanation = '';
                
                if (userVerificationFirst && userVerificationFirst.trim() !== '' && userVerificationAnswer && userVerificationAnswer.trim() !== '') {
                    // éªŒç®—é€»è¾‘ï¼šç”¨æˆ·å¡«å†™çš„ç­”æ¡ˆ è¿ç®—ç¬¦ é¢˜ç›®ç¬¬ä¸€è¡Œæ•°å­— = éªŒç®—ç»“æœ
                    // éªŒç®—ç»“æœåº”è¯¥ç­‰äºé¢˜ç›®ç¬¬äºŒè¡Œæ•°å­—
                    
                    const userFirstNum = parseFloat(userVerificationFirst);
                    const userResultNum = parseFloat(userVerificationAnswer);
                    
                    if (problem.type === 'ä¹˜æ³•') {
                        // éªŒç®—ï¼šç”¨æˆ·ç­”æ¡ˆ Ã· ä¸€ä½æ•° = ä¸‰ä½æ•°
                        let divisor;
                        if (problem.num1 >= 100) {
                            divisor = problem.num2;
                        } else {
                            divisor = problem.num1;
                        }
                        verificationCorrectAnswer = divisor;
                        const expectedResult = userFirstNum / divisor;
                        isVerificationCorrect = Math.abs(expectedResult - userResultNum) < 0.001; // å…è®¸æµ®ç‚¹æ•°ç²¾åº¦è¯¯å·®
                        verificationExplanation = `${userFirstNum} Ã· ${divisor} = ${expectedResult.toFixed(0)} (åº”è¯¥æ˜¯${problem.num1 >= 100 ? problem.num1 : problem.num2})`;
                    } else {
                        // éªŒç®—ï¼šç”¨æˆ·ç­”æ¡ˆ è¿ç®—ç¬¦ é¢˜ç›®ç¬¬ä¸€è¡Œæ•°å­— = éªŒç®—ç»“æœ
                        let expectedResult = 0;
                        switch (problem.operator) {
                            case '+':
                                expectedResult = userFirstNum + problem.num1;
                                break;
                            case '-':
                                expectedResult = userFirstNum - problem.num1;
                                break;
                        }
                        verificationCorrectAnswer = problem.num2;
                        isVerificationCorrect = Math.abs(expectedResult - userResultNum) < 0.001;
                        verificationExplanation = `${userFirstNum} ${problem.operator} ${problem.num1} = ${expectedResult} (åº”è¯¥æ˜¯${problem.num2})`;
                    }
                }
                
                // åªæœ‰ç­”æ¡ˆå’Œè¿›ä½/å€Ÿä½éƒ½æ­£ç¡®æ‰ç®—å®Œå…¨æ­£ç¡®
                const isCompletelyCorrect = isAnswerCorrect && isCarryCorrect;
                
                // ç­”æ¡ˆæ­£ç¡®ä½†è¿›ä½/å€Ÿä½é”™è¯¯ - éƒ¨åˆ†æ­£ç¡®
                const isAnswerCorrectButCarryWrong = isAnswerCorrect && !isCarryCorrect;
                
                if (isCompletelyCorrect) {
                    correctCount++;
                }
                
                feedback.push({
                    question: problem.text,
                    userAnswer: userAnswer || 'æœªå¡«å†™',
                    correctAnswer: problem.correctAnswer,
                    isCorrect: isCompletelyCorrect,
                    isAnswerCorrectButCarryWrong: isAnswerCorrectButCarryWrong,
                    isAnswerCorrect: isAnswerCorrect,
                    isCarryCorrect: isCarryCorrect,
                    type: problem.type,
                    correctCarryBorrow: correctCarryBorrow,
                    userCarryBorrow: userCarryBorrow,
                    verticalForm: createVerticalForm(problem, index),
                    correctVerticalForm: createVerticalForm(problem, index, true),
                    userVerificationAnswer: userVerificationAnswer || 'æœªå¡«å†™',
                    verificationCorrectAnswer: verificationCorrectAnswer,
                    isVerificationCorrect: isVerificationCorrect,
                    verificationForm: createVerificationForm(problem, index)
                });
            });
            
            displayResults(correctCount, feedback);
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResults(correctCount, feedback) {
            const resultsDiv = document.getElementById('results');
            const percentage = Math.round((correctCount / problems.length) * 100);
            
            let resultClass = 'partial';
            let resultMessage = '';
            
            if (correctCount === problems.length) {
                resultClass = 'correct';
                resultMessage = 'ğŸ‰ æ­å–œæ‚¨ï¼Œå…¨éƒ¨ç­”å¯¹ï¼';
            } else if (correctCount === 0) {
                resultClass = 'incorrect';
                resultMessage = 'ğŸ’ª ç»§ç»­åŠªåŠ›ï¼Œå¤šç»ƒä¹ å°±èƒ½æé«˜ï¼';
            } else {
                resultClass = 'partial';
                resultMessage = 'ğŸ‘ ä¸é”™ï¼Œç»§ç»­åŠ æ²¹ï¼';
            }
            
            resultsDiv.innerHTML = `
                <div class="results ${resultClass}">
                    <div class="score">å¾—åˆ†ï¼š${correctCount}/${problems.length} (${percentage}%)</div>
                    <div>${resultMessage}</div>
                </div>
                
                <div class="feedback">
                    <h3>è¯¦ç»†åé¦ˆï¼š</h3>
                    ${feedback.map((item, index) => `
                        <div class="feedback-item ${item.isCorrect ? 'feedback-correct' : (item.isAnswerCorrectButCarryWrong ? 'feedback-partial-correct' : 'feedback-incorrect')}">
                            <strong>ç¬¬ ${index + 1} é¢˜ (${item.type})</strong><br>
                            ${item.verticalForm}<br>
                            <strong>æœ€ç»ˆç­”æ¡ˆï¼š</strong>${item.userAnswer} ${item.isAnswerCorrect ? 'âœ…' : 'âŒ'}<br>
                            ${item.type === 'åŠ æ³•' || item.type === 'ä¹˜æ³•' ? 
                                `<strong>è¿›ä½è®°å½•ï¼š</strong>åä½${item.userCarryBorrow.tens} (æ­£ç¡®: ${item.correctCarryBorrow.tens}) ${item.userCarryBorrow.tens === item.correctCarryBorrow.tens ? 'âœ…' : 'âŒ'}, ç™¾ä½${item.userCarryBorrow.hundreds} (æ­£ç¡®: ${item.correctCarryBorrow.hundreds}) ${item.userCarryBorrow.hundreds === item.correctCarryBorrow.hundreds ? 'âœ…' : 'âŒ'}, åƒä½${item.userCarryBorrow.thousands} (æ­£ç¡®: ${item.correctCarryBorrow.thousands}) ${item.userCarryBorrow.thousands === item.correctCarryBorrow.thousands ? 'âœ…' : 'âŒ'}<br>` :
                                `<strong>å€Ÿä½è®°å½•ï¼š</strong>åä½${item.userCarryBorrow.tens} (æ­£ç¡®: ${item.correctCarryBorrow.tens}) ${item.userCarryBorrow.tens === item.correctCarryBorrow.tens ? 'âœ…' : 'âŒ'}, ç™¾ä½${item.userCarryBorrow.hundreds} (æ­£ç¡®: ${item.correctCarryBorrow.hundreds}) ${item.userCarryBorrow.hundreds === item.correctCarryBorrow.hundreds ? 'âœ…' : 'âŒ'}, åƒä½${item.userCarryBorrow.thousands} (æ­£ç¡®: ${item.correctCarryBorrow.thousands}) ${item.userCarryBorrow.thousands === item.correctCarryBorrow.thousands ? 'âœ…' : 'âŒ'}<br>`
                            }
                            ${item.isCorrect ? 'ğŸ‰ å®Œå…¨æ­£ç¡®ï¼' : (item.isAnswerCorrectButCarryWrong ? 'ğŸ’¡ è®¡ç®—è¿‡ç¨‹æœ‰å°é”™è¯¯ï¼Œä½†ç­”æ¡ˆæ­£ç¡®ï¼' : `${item.correctVerticalForm}<br><strong>æ­£ç¡®ç­”æ¡ˆï¼š${item.correctAnswer}</strong>`)}
                            ${item.userVerificationAnswer !== 'æœªå¡«å†™' ? 
                                `<div style="margin-top: 10px; padding: 8px; background-color: ${item.isVerificationCorrect ? '#d4edda' : '#f8d7da'}; border-radius: 4px;">
                                    <strong>éªŒç®—ç»“æœï¼š</strong>${item.userVerificationAnswer} ${item.isVerificationCorrect ? 'âœ… éªŒç®—æ­£ç¡®ï¼' : 'âŒ éªŒç®—é”™è¯¯'}<br>
                                    ${!item.isVerificationCorrect && item.verificationCorrectAnswer ? `<span style="font-size: 12px; color: #666;">æ­£ç¡®ç­”æ¡ˆï¼š${item.verificationCorrectAnswer}</span>` : ''}
                                </div>` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
            
            resultsDiv.style.display = 'block';
            
            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // åˆ·æ–°é¢˜ç›®
        function refreshProblems() {
            // éšè—ç»“æœåŒºåŸŸ
            document.getElementById('results').style.display = 'none';
            
            // é‡æ–°ç”Ÿæˆè¯•å·ç¼–å·
            document.getElementById('paperCode').textContent = generatePaperCode();
            
            // é‡æ–°ç”Ÿæˆé¢˜ç›®
            generateProblems();
            
            // æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨
            window.scrollTo(0, 0);
        }

        // é¡µé¢åŠ è½½æ—¶ç”Ÿæˆé¢˜ç›®
        window.onload = function() {
            // ç”Ÿæˆè¯•å·ç¼–å·
            document.getElementById('paperCode').textContent = generatePaperCode();
            // ç”Ÿæˆé¢˜ç›®
            generateProblems();
        };
    </script>
</body>
</html>